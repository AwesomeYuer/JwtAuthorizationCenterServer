<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>测试 aaaa</title>
</head>
<body>


    <div>
        <button onclick="Login();" style="width:200px;height:50px;margin:20px;">嗅探</button>
    </div>

    <div>
        <button onclick="GetJwtToken();" style="width:200px;height:50px;margin:20px;">获取 jwt Token</button>
    </div>

    <div>
        <span>jwt token:</span>
        <p id="jwtTokenContent"></p>
    </div>

    <div>
        <button onclick="GetUserHomeInfo();" style="width:200px;height:50px;margin:20px;">获取用户 Home 页数据</button>
    </div>

    <div id="usershomeconfig">

    </div>

    <script src="libs/jquery/jquery-3.3.1.js"></script>

    <script>
        function Login() {

            var script = document.createElement('script');
            script.onload = function () {
                alert("Script loaded and ready");
            };
            script.src = "http://127.0.0.1:52184/";
            document.getElementsByTagName('head')[0].appendChild(script);

        }

        // 保存token
        let jwttoken = '';
        let userName = '';

        function GetJwtToken() {

            let jwtAuthorizationCenterServerUrl = 'http://127.0.0.1:52184/api/Tokens';

            $.ajax({
                type: "GET",
                url: jwtAuthorizationCenterServerUrl,
                data: { AppID: "app1" },
                dataType: "json",
                //必须有这项的配置，不然cookie无法发送至服务端
                xhrFields: {
                    withCredentials: true
                },
                success: function (json) {
                    $("#jwtTokenContent").empty();
                    $("#jwtTokenContent").html(JSON.stringify(json));

                    jwttoken = json.SecretToken;
                    userName = json.User;
                },
                error: function (json) {
                    alert(json.status);
                }
            });
        }


        function GetUserHomeInfo() {
            // 也跨域了
            let portalUrl = 'http://127.0.0.1:5000/api/StoreProcedureExecutor/aaaa/userget';

            $.ajax({
                type: "GET",
                url: portalUrl,
                dataType: "json",
                //必须有这项的配置，不然cookie无法发送至服务端
                xhrFields: {
                    withCredentials: true
                },
                beforeSend: function (xhr) {
                    // 增加 jwt 验证的 header 头
                    // 需在服务器端指定允许添加的 http request header，服务器端开启 允许匿名访问，否则无法 options 协商。
                    xhr.setRequestHeader("Microshaoft-Authorization-Bearer", jwttoken);
                },
                success: function (json) {
                    $('#usershomeconfig').empty();   //清空里面的所有内容
                    $('#usershomeconfig').html(JSON.stringify(json));
                },
                error: function (json) {
                    alert(json.status);
                }
            });

        }
    </script>
</body>
</html>